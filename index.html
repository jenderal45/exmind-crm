<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>Exmind CRM ‚Äî MVP (1 File)</title>
  <meta name="description" content="Exmind CRM MVP: Leads, Sales Pipeline, WA internal, Invoice ke Exmind Pay. Single-file HTML + CSS + JS." />

  <style>
    :root{
      --bg:#070b14;
      --panel:#0b1220;
      --card:#0f1a2f;
      --soft:#0d1730;
      --text:#e7eefc;
      --muted:#9fb0d0;
      --muted2:#7f93bb;
      --border:rgba(255,255,255,.10);
      --border2:rgba(255,255,255,.14);
      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --shadow2: 0 10px 25px rgba(0,0,0,.35);
      --ring: 0 0 0 4px rgba(111, 207, 255, .18);

      --brand:#66d9ff;
      --brand2:#7c5cff;
      --ok:#33d17a;
      --warn:#ffcc66;
      --bad:#ff6b6b;

      --radius:18px;
      --radius2:22px;
      --radius3:28px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(124,92,255,.22), transparent 55%),
        radial-gradient(900px 500px at 70% 20%, rgba(102,217,255,.18), transparent 55%),
        radial-gradient(900px 600px at 50% 95%, rgba(51,209,122,.08), transparent 60%),
        var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }

    a{color:inherit}
    .app{
      min-height:100%;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:18px;
      padding:18px;
      max-width: 1500px;
      margin:0 auto;
    }

    /* Sidebar */
    .sidebar{
      background: linear-gradient(180deg, rgba(15,26,47,.88), rgba(11,18,32,.92));
      border:1px solid var(--border);
      border-radius: var(--radius3);
      box-shadow: var(--shadow2);
      overflow:hidden;
      position:sticky;
      top:18px;
      height: calc(100vh - 36px);
      display:flex;
      flex-direction:column;
    }
    .sb-top{
      padding:18px 16px 14px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(102,217,255,.08), transparent 55%);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), transparent 45%),
        linear-gradient(135deg, rgba(102,217,255,.95), rgba(124,92,255,.9));
      box-shadow: 0 16px 35px rgba(102,217,255,.12);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute; inset:10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(8px);
    }
    .brand h1{
      font-size:15px;
      margin:0;
      letter-spacing:.2px;
      line-height:1.2;
    }
    .brand p{
      margin:2px 0 0;
      color:var(--muted);
      font-size:12px;
    }

    .sb-nav{
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .navbtn{
      width:100%;
      border:1px solid transparent;
      background: transparent;
      color:var(--text);
      padding:12px 12px;
      border-radius: 16px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      transition:.18s ease;
    }
    .navbtn:hover{
      background: rgba(255,255,255,.05);
      border-color: rgba(255,255,255,.07);
      transform: translateY(-1px);
    }
    .navbtn.active{
      background: linear-gradient(135deg, rgba(102,217,255,.10), rgba(124,92,255,.10));
      border-color: rgba(102,217,255,.18);
      box-shadow: 0 0 0 4px rgba(102,217,255,.08);
    }
    .nav-left{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .ico{
      width:36px;height:36px;border-radius:14px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.06);
      flex:0 0 auto;
    }
    .navtxt{
      display:flex; flex-direction:column;
      min-width:0;
    }
    .navtxt b{
      font-size:13px;
      font-weight:700;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .navtxt span{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      color:var(--muted);
      flex:0 0 auto;
    }

    .sb-bottom{
      margin-top:auto;
      padding:14px 12px 14px;
      border-top:1px solid var(--border);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }
    .sb-actions{
      display:flex;
      gap:10px;
    }

    /* Main */
    .main{
      display:flex;
      flex-direction:column;
      gap:14px;
      min-width:0;
    }

    .topbar{
      background: rgba(11,18,32,.75);
      border:1px solid var(--border);
      border-radius: var(--radius3);
      box-shadow: var(--shadow2);
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      backdrop-filter: blur(10px);
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .title h2{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pill{
      font-size:11px;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      color:var(--muted);
      background: rgba(255,255,255,.04);
      font-family: var(--mono);
    }
    .title p{
      margin:0;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .search{
      display:flex;
      align-items:center;
      gap:10px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding:10px 12px;
      min-width: 320px;
      max-width: 520px;
      flex:1 1 320px;
    }
    .search input{
      width:100%;
      border:0;
      outline:0;
      background: transparent;
      color:var(--text);
      font-size:13px;
    }
    .search input::placeholder{color: rgba(159,176,208,.7)}
    .chip{
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      cursor:pointer;
      transition:.15s ease;
      user-select:none;
    }
    .chip:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.16)}
    .chip.active{
      border-color: rgba(102,217,255,.28);
      background: rgba(102,217,255,.08);
      color: #dff7ff;
      box-shadow: 0 0 0 4px rgba(102,217,255,.06);
    }

    /* Buttons */
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius: 16px;
      cursor:pointer;
      transition:.18s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-weight:700;
      font-size:13px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.18)}
    .btn:active{transform: translateY(0px)}
    .btn.primary{
      border-color: rgba(102,217,255,.25);
      background: linear-gradient(135deg, rgba(102,217,255,.16), rgba(124,92,255,.12));
      box-shadow: 0 18px 45px rgba(102,217,255,.08);
    }
    .btn.good{
      border-color: rgba(51,209,122,.22);
      background: rgba(51,209,122,.10);
    }
    .btn.warn{
      border-color: rgba(255,204,102,.22);
      background: rgba(255,204,102,.08);
    }
    .btn.danger{
      border-color: rgba(255,107,107,.22);
      background: rgba(255,107,107,.08);
    }
    .btn.small{padding:8px 10px; border-radius: 14px; font-size:12px}
    .btn.icon{
      width:42px;height:42px;padding:0;border-radius:16px;
    }

    /* Layout blocks */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      min-width:0;
    }

    .panel{
      background: rgba(11,18,32,.75);
      border:1px solid var(--border);
      border-radius: var(--radius3);
      box-shadow: var(--shadow2);
      overflow:hidden;
      backdrop-filter: blur(10px);
      min-width:0;
    }
    .panel .hd{
      padding:14px 14px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .panel .hd h3{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .panel .hd .sub{
      color:var(--muted);
      font-size:12px;
      margin-top:2px;
    }
    .panel .bd{
      padding:14px;
      min-width:0;
    }

    /* Dashboard */
    .kpis{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:12px;
    }
    .kpi{
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 20px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:0;
    }
    .kpi .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .kpi .name{
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .kpi .val{
      font-size:22px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .kpi .mini{
      font-size:12px;
      color:var(--muted2);
      line-height:1.35;
    }
    .spark{
      height:8px;
      border-radius:999px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.06);
      overflow:hidden;
    }
    .spark > i{
      display:block;
      height:100%;
      width:50%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(102,217,255,.9), rgba(124,92,255,.9));
    }

    /* Leads table */
    .table-wrap{overflow:auto}
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width: 900px;
    }
    th, td{
      padding:12px 12px;
      text-align:left;
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:middle;
      font-size:13px;
    }
    th{
      color:var(--muted);
      font-weight:700;
      position:sticky;
      top:0;
      background: rgba(11,18,32,.92);
      backdrop-filter: blur(10px);
      z-index:2;
    }
    tr:hover td{background: rgba(255,255,255,.02)}
    .t-actions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .tag{
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .tag.ok{border-color: rgba(51,209,122,.25); background: rgba(51,209,122,.08); color:#c9ffe3}
    .tag.warn{border-color: rgba(255,204,102,.25); background: rgba(255,204,102,.08); color:#fff3d2}
    .tag.bad{border-color: rgba(255,107,107,.25); background: rgba(255,107,107,.08); color:#ffe0e0}
    .tag.info{border-color: rgba(102,217,255,.25); background: rgba(102,217,255,.08); color:#dff7ff}

    /* Pipeline */
    .pipeline{
      display:grid;
      grid-template-columns: repeat(6, minmax(260px, 1fr));
      gap:12px;
      overflow:auto;
      padding-bottom:6px;
    }
    .col{
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 22px;
      min-height: 520px;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .col .ch{
      padding:12px 12px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      background: rgba(255,255,255,.02);
    }
    .col .ch b{
      font-size:13px;
      display:block;
      margin-bottom:4px;
    }
    .col .ch span{
      font-size:12px;
      color:var(--muted);
    }
    .col .drop{
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height: 200px;
      flex:1 1 auto;
    }

    .deal{
      border-radius: 18px;
      padding:12px;
      background: rgba(15,26,47,.75);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      cursor:grab;
      user-select:none;
      transition:.15s ease;
    }
    .deal:active{cursor:grabbing}
    .deal:hover{transform: translateY(-2px); border-color: rgba(255,255,255,.16)}
    .deal .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .deal .name{
      font-weight:900;
      font-size:13px;
      letter-spacing:.2px;
      margin:0;
      line-height:1.25;
    }
    .deal .meta{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .money{
      font-family: var(--mono);
      font-weight:800;
      color:#dff7ff;
      font-size:12px;
      letter-spacing:.2px;
    }
    .deal .mini{
      margin-top:8px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .deal .row{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    /* Invoice */
    .inv-grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:12px;
      align-items:start;
    }
    .card{
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 22px;
      padding:12px;
      min-width:0;
    }
    .card h4{
      margin:0 0 10px;
      font-size:13px;
      letter-spacing:.2px;
    }
    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .field{display:flex; flex-direction:column; gap:6px; min-width:0}
    label{font-size:12px; color:var(--muted)}
    input, select, textarea{
      width:100%;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      padding:10px 10px;
      border-radius: 16px;
      outline:none;
      font-size:13px;
      transition:.15s ease;
    }
    textarea{min-height:92px; resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(102,217,255,.30);
      box-shadow: var(--ring);
    }
    .form .full{grid-column: 1 / -1}
    .hr{
      height:1px;
      background: rgba(255,255,255,.06);
      margin:12px 0;
    }
    .kv{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .kv .item{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:10px;
      border-radius: 16px;
      background: rgba(255,255,255,.02);
      border:1px solid rgba(255,255,255,.06);
    }
    .kv .item b{font-size:12px}
    .kv .item span{
      color:var(--muted);
      font-size:12px;
      font-family: var(--mono);
      text-align:right;
    }

    /* Modal */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
    }
    .modal.open{display:flex}
    .sheet{
      width:min(980px, 100%);
      border-radius: 28px;
      background: linear-gradient(180deg, rgba(15,26,47,.92), rgba(11,18,32,.92));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 35px 120px rgba(0,0,0,.65);
      overflow:hidden;
      transform: translateY(8px);
      animation: pop .18s ease forwards;
    }
    @keyframes pop{
      to{transform: translateY(0)}
    }
    .sheet .sh{
      padding:14px 14px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .sheet .sh h3{
      margin:0;
      font-size:14px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .sheet .sb{
      padding:14px;
    }

    /* Toast */
    .toast{
      position:fixed;
      right:16px;
      bottom:16px;
      z-index:60;
      display:flex;
      flex-direction:column;
      gap:10px;
      pointer-events:none;
    }
    .toast .t{
      pointer-events:auto;
      background: rgba(11,18,32,.85);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding:12px 12px;
      min-width: 280px;
      max-width: 380px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      display:flex;
      gap:10px;
      align-items:flex-start;
      animation: slide .18s ease;
    }
    @keyframes slide{
      from{transform: translateY(10px); opacity:0}
      to{transform: translateY(0); opacity:1}
    }
    .t .dot{
      width:12px;height:12px;border-radius:999px;
      margin-top:3px;
      background: var(--brand);
      box-shadow: 0 0 0 4px rgba(102,217,255,.12);
      flex:0 0 auto;
    }
    .t .msg{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .t .msg b{font-size:13px}
    .t .msg span{font-size:12px;color:var(--muted);line-height:1.35}
    .t .x{
      margin-left:auto;
      pointer-events:auto;
      border:0;
      background: transparent;
      color: rgba(255,255,255,.65);
      cursor:pointer;
      font-size:16px;
      line-height:1;
    }
    .t.good .dot{background: var(--ok); box-shadow: 0 0 0 4px rgba(51,209,122,.12)}
    .t.warn .dot{background: var(--warn); box-shadow: 0 0 0 4px rgba(255,204,102,.12)}
    .t.bad .dot{background: var(--bad); box-shadow: 0 0 0 4px rgba(255,107,107,.12)}

    /* Responsive */
    @media (max-width: 1100px){
      .app{grid-template-columns: 1fr}
      .sidebar{position:relative; height:auto}
      .search{min-width: 0; flex: 1 1 240px}
      .kpis{grid-template-columns: repeat(2, minmax(0, 1fr))}
      .inv-grid{grid-template-columns: 1fr}
      table{min-width: 820px}
    }
    @media (max-width: 520px){
      .topbar{flex-direction:column; align-items:stretch}
      .top-actions{justify-content:stretch}
      .btn{width:100%}
      .btn.icon{width:100%}
      .search{min-width: 0}
      .kpis{grid-template-columns: 1fr}
      .form{grid-template-columns: 1fr}
      table{min-width: 760px}
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sb-top">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>Exmind CRM</h1>
            <p>MVP ‚Ä¢ Leads ‚Üí Pipeline ‚Üí WA ‚Üí Invoice</p>
          </div>
        </div>
      </div>

      <nav class="sb-nav">
        <button class="navbtn active" data-view="dashboard">
          <div class="nav-left">
            <div class="ico">üìä</div>
            <div class="navtxt">
              <b>Dashboard</b>
              <span>Ringkasan kinerja</span>
            </div>
          </div>
          <span class="badge" id="sbTotalDeals">0</span>
        </button>

        <button class="navbtn" data-view="leads">
          <div class="nav-left">
            <div class="ico">üß≤</div>
            <div class="navtxt">
              <b>Leads</b>
              <span>Prospek & sumber</span>
            </div>
          </div>
          <span class="badge" id="sbTotalLeads">0</span>
        </button>

        <button class="navbtn" data-view="pipeline">
          <div class="nav-left">
            <div class="ico">üß©</div>
            <div class="navtxt">
              <b>Pipeline</b>
              <span>Drag & drop deals</span>
            </div>
          </div>
          <span class="badge" id="sbWon">0 Won</span>
        </button>

        <button class="navbtn" data-view="invoices">
          <div class="nav-left">
            <div class="ico">üßæ</div>
            <div class="navtxt">
              <b>Invoices</b>
              <span>Exmind Pay link & status</span>
            </div>
          </div>
          <span class="badge" id="sbPaid">0 Paid</span>
        </button>
      </nav>

      <div class="sb-bottom">
        <div class="hint">
          <b style="color:#dff7ff">Tips cepat:</b><br/>
          ‚Ä¢ Drag deal antar stage<br/>
          ‚Ä¢ Klik deal untuk detail & WA<br/>
          ‚Ä¢ Deal Won ‚Üí buat invoice Exmind Pay
        </div>
        <div class="sb-actions">
          <button class="btn small" id="btnSeed">‚ú® Seed Demo</button>
          <button class="btn small danger" id="btnReset">üóë Reset</button>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <!-- TOPBAR -->
      <div class="topbar">
        <div class="title">
          <h2>
            CRM & Sales Automation
            <span class="pill" id="envPill">localStorage</span>
          </h2>
          <p id="subtitle">Kelola leads, follow-up via WA internal, dan buat invoice ke Exmind Pay.</p>
        </div>

        <div class="top-actions">
          <div class="search">
            <span style="opacity:.75">üîé</span>
            <input id="q" type="text" placeholder="Cari lead / deal / perusahaan / nomor WA..." />
            <span class="chip active" data-filter="all">All</span>
            <span class="chip" data-filter="today">Today</span>
            <span class="chip" data-filter="hot">Hot</span>
          </div>

          <button class="btn primary" id="btnNewLead">‚ûï Lead</button>
          <button class="btn" id="btnNewDeal">‚ûï Deal</button>
          <button class="btn icon" id="btnExport" title="Export JSON">‚¨áÔ∏è</button>
        </div>
      </div>

      <!-- VIEWS -->
      <section class="grid">
        <!-- DASHBOARD -->
        <div class="panel view" id="view-dashboard">
          <div class="hd">
            <div>
              <h3>üìä Dashboard</h3>
              <div class="sub">Ringkasan performa sales, leads, dan invoice.</div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
              <button class="btn small" id="btnQuickFollow">üì© Follow Up Hari Ini</button>
              <button class="btn small good" id="btnQuickInvoice">üßæ Invoice dari Won</button>
            </div>
          </div>
          <div class="bd">
            <div class="kpis">
              <div class="kpi">
                <div class="top">
                  <div class="name">Total Leads</div>
                  <div class="tag info">Live</div>
                </div>
                <div class="val" id="kpiLeads">0</div>
                <div class="spark"><i id="sparkLeads"></i></div>
                <div class="mini">Jumlah prospek yang tersimpan di sistem.</div>
              </div>

              <div class="kpi">
                <div class="top">
                  <div class="name">Active Deals</div>
                  <div class="tag warn">Pipeline</div>
                </div>
                <div class="val" id="kpiDeals">0</div>
                <div class="spark"><i id="sparkDeals"></i></div>
                <div class="mini">Deal yang masih berjalan (bukan Won/Lost).</div>
              </div>

              <div class="kpi">
                <div class="top">
                  <div class="name">Won Revenue</div>
                  <div class="tag ok">Won</div>
                </div>
                <div class="val" id="kpiWon">Rp0</div>
                <div class="spark"><i id="sparkWon"></i></div>
                <div class="mini">Total estimasi revenue dari deal Won.</div>
              </div>

              <div class="kpi">
                <div class="top">
                  <div class="name">Paid Invoices</div>
                  <div class="tag ok">Exmind Pay</div>
                </div>
                <div class="val" id="kpiPaid">0</div>
                <div class="spark"><i id="sparkPaid"></i></div>
                <div class="mini">Invoice yang sudah ditandai Paid.</div>
              </div>
            </div>

            <div class="hr"></div>

            <div style="display:grid; grid-template-columns: 1.2fr .8fr; gap:12px; align-items:start">
              <div class="card">
                <h4>üî• Hot Leads / Deals (prioritas follow up)</h4>
                <div id="hotList" class="kv"></div>
              </div>

              <div class="card">
                <h4>üß† Activity Suggestions</h4>
                <div class="kv" id="suggestions"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- LEADS -->
        <div class="panel view" id="view-leads" style="display:none">
          <div class="hd">
            <div>
              <h3>üß≤ Leads</h3>
              <div class="sub">Kelola prospek, status, sumber, dan follow up.</div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
              <button class="btn small" id="btnImportCSV">üì• Import CSV</button>
              <button class="btn small" id="btnAddFromDeal">‚ûï Lead dari Deal</button>
            </div>
          </div>

          <div class="bd">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th style="width:18%">Nama</th>
                    <th style="width:18%">Perusahaan</th>
                    <th style="width:16%">WhatsApp</th>
                    <th style="width:12%">Source</th>
                    <th style="width:12%">Status</th>
                    <th style="width:12%">Owner</th>
                    <th style="width:12%; text-align:right">Aksi</th>
                  </tr>
                </thead>
                <tbody id="leadRows"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- PIPELINE -->
        <div class="panel view" id="view-pipeline" style="display:none">
          <div class="hd">
            <div>
              <h3>üß© Sales Pipeline</h3>
              <div class="sub">Drag & drop deal antar stage. Klik untuk detail.</div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
              <button class="btn small" id="btnStageConfig">‚öôÔ∏è Stage</button>
              <button class="btn small good" id="btnWonToInvoice">üßæ Won ‚Üí Invoice</button>
            </div>
          </div>
          <div class="bd">
            <div class="pipeline" id="pipeline"></div>
          </div>
        </div>

        <!-- INVOICES -->
        <div class="panel view" id="view-invoices" style="display:none">
          <div class="hd">
            <div>
              <h3>üßæ Invoices (ExmindPay)</h3>
              <div class="sub">Buat invoice dari deal Won, generate link ExmindPay, dan track status.</div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
              <button class="btn small" id="btnNewInvoice">‚ûï Invoice</button>
              <button class="btn small" id="btnMarkAllPending">‚è≥ Mark Pending</button>
            </div>
          </div>
          <div class="bd">
            <div class="inv-grid">
              <div class="card">
                <h4>Daftar Invoice</h4>
                <div class="table-wrap">
                  <table style="min-width: 860px">
                    <thead>
                      <tr>
                        <th style="width:16%">No</th>
                        <th style="width:22%">Customer</th>
                        <th style="width:16%">Total</th>
                        <th style="width:16%">Status</th>
                        <th style="width:16%">Due</th>
                        <th style="width:14%; text-align:right">Aksi</th>
                      </tr>
                    </thead>
                    <tbody id="invoiceRows"></tbody>
                  </table>
                </div>
              </div>

              <div class="card">
                <h4>Preview Invoice</h4>
                <div class="kv" id="invoicePreview">
                  <div class="item">
                    <div>
                      <b>Belum ada invoice dipilih</b>
                      <div style="color:var(--muted); font-size:12px; margin-top:4px">
                        Klik salah satu invoice untuk melihat detail dan link ExmindPay.
                      </div>
                    </div>
                    <span>‚Äî</span>
                  </div>
                </div>

                <div class="hr"></div>

                <div style="display:flex; gap:10px; flex-wrap:wrap">
                  <button class="btn good" id="btnPayExmindPay" disabled>üí≥ Bayar via ExmindPay</button>
                  <button class="btn" id="btnCopyPayLink" disabled>üîó Copy Link</button>
                  <button class="btn warn" id="btnMarkPaid" disabled>‚úÖ Mark Paid</button>
                  <button class="btn danger" id="btnDeleteInvoice" disabled>üóë Hapus</button>
                </div>
              </div>
            </div>
          </div>
        </div>

      </section>
    </main>
  </div>

  <!-- MODAL -->
  <div class="modal" id="modal">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="sh">
        <h3 id="modalTitle">Modal</h3>
        <button class="btn icon" id="modalClose" title="Close">‚úï</button>
      </div>
      <div class="sb" id="modalBody"></div>
    </div>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast"></div>

  <input type="file" id="csvFile" accept=".csv" style="display:none" />

  <script>
    /******************************************************************
     * Exmind CRM MVP (Single File)
     * - Leads
     * - Pipeline (drag & drop)
     * - WA internal (wa.me link + templates)
     * - Invoice -> ExmindPay link (dummy)
     * Data: localStorage
     ******************************************************************/

    const LS_KEY = "Exmind_crm_mvp_v1";

    const DEFAULT_STAGES = [
      { id:"new",        name:"New Lead",        hint:"Baru masuk" },
      { id:"followup",   name:"Follow Up",       hint:"Kontak awal" },
      { id:"meeting",    name:"Meeting",         hint:"Diskusi" },
      { id:"proposal",   name:"Proposal",        hint:"Kirim penawaran" },
      { id:"nego",       name:"Negotiation",     hint:"Negosiasi" },
      { id:"won",        name:"Won",             hint:"Deal jadi" },
      { id:"lost",       name:"Lost",            hint:"Tidak lanjut" },
    ];

    const OWNERS = ["Admin", "Sales A", "Sales B", "Sales C"];
    const SOURCES = ["Instagram", "Ads", "Website", "Referral", "Event", "WhatsApp", "Other"];
    const LEAD_STATUS = ["New", "Contacted", "Qualified", "Lost"];

    const state = load() || {
      meta: {
        createdAt: Date.now(),
        exmindpayBaseUrl: "https://exmindpay.local/pay", // dummy
        company: "Astria Group",
      },
      stages: DEFAULT_STAGES,
      leads: [],
      deals: [],
      invoices: [],
      ui: {
        view: "dashboard",
        filter: "all",
        selectedInvoiceId: null,
      }
    };

    // ---------- Helpers ----------
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const uid = (p="id") => `${p}_${Math.random().toString(16).slice(2)}_${Date.now().toString(16)}`;
    const fmtIDR = (n) => {
      n = Number(n || 0);
      return new Intl.NumberFormat("id-ID", { style:"currency", currency:"IDR", maximumFractionDigits:0 }).format(n);
    };
    const fmtDate = (ts) => {
      if(!ts) return "‚Äî";
      const d = new Date(ts);
      return d.toLocaleDateString("id-ID", { year:"numeric", month:"short", day:"2-digit" });
    };
    const todayKey = () => {
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    };
    const dateKey = (ts) => {
      const d = new Date(ts);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    };

    function save(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      render();
    }
    function load(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){
        return null;
      }
    }

    function toast(msg, type="info", title="Exmind CRM"){
      const host = $("#toast");
      const el = document.createElement("div");
      el.className = `t ${type}`;
      el.innerHTML = `
        <div class="dot"></div>
        <div class="msg">
          <b>${escapeHtml(title)}</b>
          <span>${escapeHtml(msg)}</span>
        </div>
        <button class="x" aria-label="Close">‚úï</button>
      `;
      host.appendChild(el);
      el.querySelector(".x").onclick = () => el.remove();
      setTimeout(()=>{ if(el.isConnected) el.remove(); }, 5200);
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function normalizePhone(input){
      // Accept: 08xxx, +62xxx, 62xxx
      let s = String(input || "").trim().replaceAll(" ","").replaceAll("-","");
      if(!s) return "";
      if(s.startsWith("+")) s = s.slice(1);
      if(s.startsWith("0")) s = "62" + s.slice(1);
      if(!s.startsWith("62")) {
        // fallback: assume already correct or local
        if(s.length >= 9) s = "62" + s.replace(/^0+/,"");
      }
      return s.replace(/\D/g,"");
    }

    function waLink(phone, text){
      const p = normalizePhone(phone);
      if(!p) return null;
      const t = encodeURIComponent(text || "");
      return `https://wa.me/${p}${t ? `?text=${t}` : ""}`;
    }

    function stageById(id){
      return state.stages.find(s => s.id === id);
    }

    function isHot(item){
      // hot if value >= 25jt or followup due today or status new
      const v = Number(item.value || 0);
      const due = item.followUpAt ? dateKey(item.followUpAt) : null;
      return v >= 25000000 || due === todayKey() || item.status === "New";
    }

    function currentQuery(){
      return ($("#q")?.value || "").trim().toLowerCase();
    }

    function filterMatch(obj, q){
      if(!q) return true;
      const hay = [
        obj.name, obj.company, obj.phone, obj.source, obj.owner,
        obj.title, obj.notes, obj.stageId, obj.status
      ].filter(Boolean).join(" ").toLowerCase();
      return hay.includes(q);
    }

    // ---------- Seed demo ----------
    function seed(){
      const now = Date.now();
      const leads = [
        { id:uid("lead"), name:"Rizky", company:"PT Sinar Abadi", phone:"081234567890", source:"Instagram", status:"New", owner:"Sales A", createdAt: now-86400000*3, notes:"Minat website company profile + SEO.", followUpAt: now+86400000*0 },
        { id:uid("lead"), name:"Dewi", company:"CV Karya Mandiri", phone:"082211112222", source:"Referral", status:"Qualified", owner:"Sales B", createdAt: now-86400000*6, notes:"Butuh ERP sederhana + training.", followUpAt: now+86400000*1 },
        { id:uid("lead"), name:"Bagas", company:"Toko Kopi Nusantara", phone:"081299998888", source:"Website", status:"Contacted", owner:"Sales A", createdAt: now-86400000*2, notes:"Ingin sistem POS + loyalty.", followUpAt: now+86400000*0 },
        { id:uid("lead"), name:"Sarah", company:"Dyora Resources", phone:"081377771111", source:"Event", status:"New", owner:"Admin", createdAt: now-86400000*1, notes:"Diskusi project branding & landing page.", followUpAt: now+86400000*2 },
      ];

      const deals = [
        { id:uid("deal"), leadId: leads[0].id, title:"Website + SEO", name:"Rizky", company:"PT Sinar Abadi", phone:leads[0].phone, owner:"Sales A", value: 18000000, stageId:"followup", createdAt: now-86400000*3, followUpAt: now+86400000*0, notes:"Tawarkan paket 3 bulan SEO + maintenance." },
        { id:uid("deal"), leadId: leads[1].id, title:"ERP Basic", name:"Dewi", company:"CV Karya Mandiri", phone:leads[1].phone, owner:"Sales B", value: 65000000, stageId:"proposal", createdAt: now-86400000*6, followUpAt: now+86400000*1, notes:"Kirim proposal modul Finance + Inventory." },
        { id:uid("deal"), leadId: leads[2].id, title:"POS + Loyalty", name:"Bagas", company:"Toko Kopi Nusantara", phone:leads[2].phone, owner:"Sales A", value: 32000000, stageId:"meeting", createdAt: now-86400000*2, followUpAt: now+86400000*0, notes:"Meeting online jam 19.00." },
        { id:uid("deal"), leadId: leads[3].id, title:"Branding + Landing", name:"Sarah", company:"Dyora Resources", phone:leads[3].phone, owner:"Admin", value: 24000000, stageId:"new", createdAt: now-86400000*1, followUpAt: now+86400000*2, notes:"Minta contoh portfolio." },
        { id:uid("deal"), leadId: null, title:"Corporate Website", name:"Andi", company:"PT Maju Bersama", phone:"081333339999", owner:"Sales C", value: 90000000, stageId:"won", createdAt: now-86400000*8, followUpAt: now-86400000*2, notes:"Sudah deal. Tinggal invoice." },
      ];

      const invoices = [
        {
          id: uid("inv"),
          number: makeInvoiceNumber(),
          customerName: "PT Maju Bersama",
          customerPhone: "081333339999",
          items: [{ name:"Corporate Website", qty:1, price: 90000000 }],
          taxPct: 0,
          discount: 0,
          status: "unpaid",
          dueAt: now + 86400000*5,
          createdAt: now-86400000*1,
          dealId: deals[4].id,
          exmindpayLink: makeExmindPayLink("PT Maju Bersama", 90000000),
          notes: "Pembayaran DP 100% untuk MVP."
        }
      ];

      state.leads = leads;
      state.deals = deals;
      state.invoices = invoices;
      state.ui.selectedInvoiceId = invoices[0].id;
      save();
      toast("Demo data berhasil ditambahkan.", "good", "Seed Demo");
    }

    function resetAll(){
      localStorage.removeItem(LS_KEY);
      location.reload();
    }

    // ---------- Invoice helpers ----------
    function makeInvoiceNumber(){
      // INV-YYYYMM-XXXX
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const base = `INV-${y}${m}-`;
      const count = state.invoices.filter(i => (i.number||"").startsWith(base)).length + 1;
      return base + String(count).padStart(4,"0");
    }

    function calcInvoiceTotal(inv){
      const subtotal = (inv.items || []).reduce((a,it)=> a + (Number(it.qty||0) * Number(it.price||0)), 0);
      const disc = Number(inv.discount || 0);
      const tax = Math.round((subtotal - disc) * (Number(inv.taxPct||0) / 100));
      return Math.max(0, subtotal - disc + tax);
    }

    function makeExmindPayLink(customerName, amount, invoiceId){
      // Dummy link. Nanti tinggal ganti baseUrl + parameter asli ExmindPay.
      const base = state.meta.exmindpayBaseUrl || "https://exmindpay.local/pay";
      const q = new URLSearchParams({
        merchant: "Exmind_crm",
        customer: customerName || "Customer",
        amount: String(Math.max(0, Math.round(Number(amount||0)))),
        ref: invoiceId || uid("ref"),
      });
      return `${base}?${q.toString()}`;
    }

    // ---------- Modal ----------
    const modal = $("#modal");
    const modalTitle = $("#modalTitle");
    const modalBody = $("#modalBody");
    $("#modalClose").onclick = closeModal;
    modal.addEventListener("click", (e)=>{
      if(e.target === modal) closeModal();
    });
    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape" && modal.classList.contains("open")) closeModal();
    });

    function openModal(title, html){
      modalTitle.innerHTML = title;
      modalBody.innerHTML = html;
      modal.classList.add("open");
    }
    function closeModal(){
      modal.classList.remove("open");
      modalBody.innerHTML = "";
    }

    // ---------- Views ----------
    function setView(view){
      state.ui.view = view;
      $$(".navbtn").forEach(b => b.classList.toggle("active", b.dataset.view === view));
      $$(".view").forEach(v => v.style.display = "none");
      $(`#view-${view}`).style.display = "block";

      const sub = $("#subtitle");
      const map = {
        dashboard: "Ringkasan kinerja sales, leads, dan invoice.",
        leads: "Kelola prospek (leads), status, sumber, dan follow up.",
        pipeline: "Drag & drop deals antar stage. Klik deal untuk detail.",
        invoices: "Buat invoice dari deal Won, generate link ExmindPay, dan track status.",
      };
      sub.textContent = map[view] || "Exmind CRM MVP";

      save(); // persist ui
    }

    // ---------- Render ----------
    function render(){
      // sidebar stats
      $("#sbTotalLeads").textContent = state.leads.length;
      $("#sbTotalDeals").textContent = state.deals.length;

      const wonDeals = state.deals.filter(d => d.stageId === "won");
      $("#sbWon").textContent = `${wonDeals.length} Won`;

      const paidInv = state.invoices.filter(i => i.status === "paid").length;
      $("#sbPaid").textContent = `${paidInv} Paid`;

      // kpis
      const activeDeals = state.deals.filter(d => !["won","lost"].includes(d.stageId));
      $("#kpiLeads").textContent = state.leads.length;
      $("#kpiDeals").textContent = activeDeals.length;

      const wonRevenue = wonDeals.reduce((a,d)=> a + Number(d.value||0), 0);
      $("#kpiWon").textContent = fmtIDR(wonRevenue);
      $("#kpiPaid").textContent = paidInv;

      // sparks (fake % based on counts)
      $("#sparkLeads").style.width = clampPct((state.leads.length/20)*100) + "%";
      $("#sparkDeals").style.width = clampPct((activeDeals.length/12)*100) + "%";
      $("#sparkWon").style.width = clampPct((wonRevenue/150000000)*100) + "%";
      $("#sparkPaid").style.width = clampPct((paidInv/10)*100) + "%";

      // hot list
      renderHot();
      renderSuggestions();

      // leads table
      renderLeads();

      // pipeline
      renderPipeline();

      // invoices
      renderInvoices();

      // chips
      $$(".chip").forEach(c => c.classList.toggle("active", c.dataset.filter === state.ui.filter));

      // enable invoice preview actions
      updateInvoicePreview();

      // keep view
      $$(".view").forEach(v => v.style.display = "none");
      $(`#view-${state.ui.view}`).style.display = "block";
    }

    function clampPct(n){
      n = Number(n||0);
      return Math.max(8, Math.min(100, Math.round(n)));
    }

    function renderHot(){
      const host = $("#hotList");
      const q = currentQuery();

      const hotLeads = state.leads
        .filter(l => filterMatch(l,q))
        .filter(l => isHot(l))
        .slice(0, 6);

      const hotDeals = state.deals
        .filter(d => filterMatch(d,q))
        .filter(d => isHot(d))
        .slice(0, 6);

      const items = [
        ...hotDeals.map(d => ({ type:"deal", obj:d })),
        ...hotLeads.map(l => ({ type:"lead", obj:l })),
      ].slice(0, 8);

      if(items.length === 0){
        host.innerHTML = `
          <div class="item">
            <div>
              <b>Belum ada hot item</b>
              <div style="color:var(--muted); font-size:12px; margin-top:4px">
                Tambahkan lead/deal atau gunakan Seed Demo.
              </div>
            </div>
            <span>‚Äî</span>
          </div>
        `;
        return;
      }

      host.innerHTML = items.map(it => {
        const o = it.obj;
        const title = it.type === "deal" ? (o.title || "Deal") : (o.name || "Lead");
        const sub = it.type === "deal"
          ? `${o.company || "‚Äî"} ‚Ä¢ ${fmtIDR(o.value||0)} ‚Ä¢ ${stageById(o.stageId)?.name || o.stageId}`
          : `${o.company || "‚Äî"} ‚Ä¢ ${o.status || "‚Äî"} ‚Ä¢ ${o.source || "‚Äî"}`;
        const due = o.followUpAt ? fmtDate(o.followUpAt) : "‚Äî";

        return `
          <div class="item">
            <div style="min-width:0">
              <b>${escapeHtml(title)}</b>
              <div style="color:var(--muted); font-size:12px; margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">
                ${escapeHtml(sub)}
              </div>
              <div style="color:var(--muted2); font-size:12px; margin-top:6px">
                Follow-up: <span style="font-family:var(--mono)">${escapeHtml(due)}</span>
              </div>
            </div>
            <span>
              <button class="btn small" onclick="window.__openWA('${escapeHtml(o.phone||"")}','${escapeHtml(it.type)}','${escapeHtml(o.id)}')">WA</button>
            </span>
          </div>
        `;
      }).join("");
    }

    function renderSuggestions(){
      const host = $("#suggestions");
      const q = currentQuery();

      const dueTodayDeals = state.deals
        .filter(d => filterMatch(d,q))
        .filter(d => d.followUpAt && dateKey(d.followUpAt) === todayKey())
        .slice(0, 4);

      const wonNoInvoice = state.deals
        .filter(d => filterMatch(d,q))
        .filter(d => d.stageId === "won")
        .filter(d => !state.invoices.some(inv => inv.dealId === d.id))
        .slice(0, 4);

      const parts = [];

      parts.push(`
        <div class="item">
          <div>
            <b>Follow-up due hari ini</b>
            <div style="color:var(--muted); font-size:12px; margin-top:4px">
              ${dueTodayDeals.length ? `${dueTodayDeals.length} deal butuh follow-up.` : "Tidak ada follow-up due hari ini."}
            </div>
          </div>
          <span><button class="btn small" onclick="window.__jump('pipeline')">Buka</button></span>
        </div>
      `);

      parts.push(`
        <div class="item">
          <div>
            <b>Deal Won belum dibuat invoice</b>
            <div style="color:var(--muted); font-size:12px; margin-top:4px">
              ${wonNoInvoice.length ? `${wonNoInvoice.length} deal siap dibuat invoice Exmind Pay.` : "Semua Won sudah ada invoice."}
            </div>
          </div>
          <span><button class="btn small good" onclick="window.__wonToInvoice()">Invoice</button></span>
        </div>
      `);

      parts.push(`
        <div class="item">
          <div>
            <b>Template follow-up</b>
            <div style="color:var(--muted); font-size:12px; margin-top:4px">
              Gunakan WA template untuk mempercepat closing.
            </div>
          </div>
          <span><button class="btn small" onclick="window.__openTemplates()">Template</button></span>
        </div>
      `);

      host.innerHTML = parts.join("");
    }

    function renderLeads(){
      const host = $("#leadRows");
      const q = currentQuery();

      const list = state.leads
        .filter(l => filterMatch(l,q))
        .sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));

      if(list.length === 0){
        host.innerHTML = `
          <tr>
            <td colspan="7" style="color:var(--muted); padding:18px">
              Belum ada leads. Klik <b>‚ûï Lead</b> atau gunakan <b>Seed Demo</b>.
            </td>
          </tr>
        `;
        return;
      }

      host.innerHTML = list.map(l => {
        const st = l.status || "New";
        const tagCls = st === "Qualified" ? "ok" : st === "Contacted" ? "warn" : st === "Lost" ? "bad" : "info";

        return `
          <tr>
            <td>
              <div style="display:flex; flex-direction:column; gap:4px">
                <b>${escapeHtml(l.name||"‚Äî")}</b>
                <span style="color:var(--muted); font-size:12px">${fmtDate(l.createdAt)}</span>
              </div>
            </td>
            <td>${escapeHtml(l.company||"‚Äî")}</td>
            <td style="font-family:var(--mono)">${escapeHtml(l.phone||"‚Äî")}</td>
            <td><span class="tag">${escapeHtml(l.source||"‚Äî")}</span></td>
            <td><span class="tag ${tagCls}">${escapeHtml(st)}</span></td>
            <td><span class="tag">${escapeHtml(l.owner||"‚Äî")}</span></td>
            <td style="text-align:right">
              <div class="t-actions">
                <button class="btn small" onclick="window.__leadToDeal('${l.id}')">‚ûï Deal</button>
                <button class="btn small" onclick="window.__editLead('${l.id}')">‚úèÔ∏è Edit</button>
                <button class="btn small" onclick="window.__openWA('${escapeHtml(l.phone||"")}','lead','${l.id}')">WA</button>
                <button class="btn small danger" onclick="window.__deleteLead('${l.id}')">üóë</button>
              </div>
            </td>
          </tr>
        `;
      }).join("");
    }

    function renderPipeline(){
      const host = $("#pipeline");
      const q = currentQuery();

      const stages = state.stages.filter(s => s.id !== "lost" || true); // keep
      host.innerHTML = stages.map(s => {
        const deals = state.deals
          .filter(d => d.stageId === s.id)
          .filter(d => filterMatch(d,q))
          .sort((a,b)=> (b.value||0)-(a.value||0));

        const sum = deals.reduce((a,d)=> a + Number(d.value||0), 0);

        return `
          <div class="col" data-stage="${escapeHtml(s.id)}">
            <div class="ch">
              <div style="min-width:0">
                <b>${escapeHtml(s.name)}</b>
                <span>${deals.length} deal ‚Ä¢ ${fmtIDR(sum)}</span>
              </div>
              <span class="tag">${escapeHtml(s.id)}</span>
            </div>
            <div class="drop" data-drop="${escapeHtml(s.id)}">
              ${deals.map(d => dealCard(d)).join("")}
              ${deals.length ? "" : `<div style="color:var(--muted); font-size:12px; padding:8px 6px">Drop deal di sini‚Ä¶</div>`}
            </div>
          </div>
        `;
      }).join("");

      // drag handlers
      $$(".deal").forEach(el => {
        el.addEventListener("dragstart", (e)=>{
          e.dataTransfer.setData("text/plain", el.dataset.id);
          e.dataTransfer.effectAllowed = "move";
          setTimeout(()=> el.style.opacity = ".55", 0);
        });
        el.addEventListener("dragend", ()=>{
          el.style.opacity = "1";
        });
      });

      $$(".drop").forEach(drop => {
        drop.addEventListener("dragover", (e)=>{
          e.preventDefault();
          drop.style.outline = "2px dashed rgba(102,217,255,.35)";
          drop.style.outlineOffset = "6px";
        });
        drop.addEventListener("dragleave", ()=>{
          drop.style.outline = "";
          drop.style.outlineOffset = "";
        });
        drop.addEventListener("drop", (e)=>{
          e.preventDefault();
          drop.style.outline = "";
          drop.style.outlineOffset = "";
          const id = e.dataTransfer.getData("text/plain");
          const stageId = drop.dataset.drop;
          moveDeal(id, stageId);
        });
      });
    }

    function dealCard(d){
      const st = d.stageId;
      const tag = st === "won" ? "ok" : st === "lost" ? "bad" : st === "proposal" ? "warn" : "info";
      const due = d.followUpAt ? fmtDate(d.followUpAt) : "‚Äî";
      const hot = isHot(d);

      return `
        <div class="deal" draggable="true" data-id="${escapeHtml(d.id)}" onclick="window.__openDeal('${escapeHtml(d.id)}')">
          <div class="top">
            <div style="min-width:0">
              <div class="name">${escapeHtml(d.title || "Deal")}</div>
              <div style="color:var(--muted); font-size:12px; margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">
                ${escapeHtml(d.company || "‚Äî")} ‚Ä¢ ${escapeHtml(d.name || "‚Äî")}
              </div>
            </div>
            <span class="tag ${tag}">${escapeHtml(stageById(st)?.name || st)}</span>
          </div>

          <div class="meta">
            <span class="tag">üë§ ${escapeHtml(d.owner || "‚Äî")}</span>
            <span class="tag">üìÖ ${escapeHtml(due)}</span>
            ${hot ? `<span class="tag warn">üî• Hot</span>` : ``}
          </div>

          <div class="mini">${escapeHtml((d.notes||"").slice(0, 92) || "‚Äî")}${(d.notes||"").length>92?"‚Ä¶":""}</div>

          <div class="row">
            <span class="money">${fmtIDR(d.value || 0)}</span>
            <button class="btn small" onclick="event.stopPropagation(); window.__openWA('${escapeHtml(d.phone||"")}','deal','${escapeHtml(d.id)}')">WA</button>
            ${d.stageId === "won"
              ? `<button class="btn small good" onclick="event.stopPropagation(); window.__dealToInvoice('${escapeHtml(d.id)}')">Invoice</button>`
              : ``}
          </div>
        </div>
      `;
    }

    function renderInvoices(){
      const host = $("#invoiceRows");
      const q = currentQuery();

      const list = state.invoices
        .filter(i => filterMatch(i,q))
        .sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));

      if(list.length === 0){
        host.innerHTML = `
          <tr>
            <td colspan="6" style="color:var(--muted); padding:18px">
              Belum ada invoice. Buat dari deal Won atau klik <b>‚ûï Invoice</b>.
            </td>
          </tr>
        `;
        return;
      }

      host.innerHTML = list.map(inv => {
        const total = calcInvoiceTotal(inv);
        const st = inv.status || "unpaid";
        const cls = st === "paid" ? "ok" : st === "pending" ? "warn" : st === "expired" ? "bad" : "info";

        return `
          <tr onclick="window.__selectInvoice('${escapeHtml(inv.id)}')" style="cursor:pointer">
            <td style="font-family:var(--mono)">${escapeHtml(inv.number || "‚Äî")}</td>
            <td>
              <div style="display:flex; flex-direction:column; gap:4px">
                <b>${escapeHtml(inv.customerName || "‚Äî")}</b>
                <span style="color:var(--muted); font-size:12px; font-family:var(--mono)">${escapeHtml(inv.customerPhone || "‚Äî")}</span>
              </div>
            </td>
            <td style="font-family:var(--mono)">${fmtIDR(total)}</td>
            <td><span class="tag ${cls}">${escapeHtml(st)}</span></td>
            <td>${fmtDate(inv.dueAt)}</td>
            <td style="text-align:right">
              <div class="t-actions">
                <button class="btn small" onclick="event.stopPropagation(); window.__openInvoice('${escapeHtml(inv.id)}')">üëÅ</button>
                <button class="btn small" onclick="event.stopPropagation(); window.__copyPayLink('${escapeHtml(inv.id)}')">üîó</button>
                <button class="btn small warn" onclick="event.stopPropagation(); window.__markPaid('${escapeHtml(inv.id)}')">‚úÖ</button>
              </div>
            </td>
          </tr>
        `;
      }).join("");
    }

    function updateInvoicePreview(){
      const id = state.ui.selectedInvoiceId;
      const inv = state.invoices.find(i => i.id === id);
      const host = $("#invoicePreview");

      const btnPay = $("#btnPayExmind Pay");
      const btnCopy = $("#btnCopyPayLink");
      const btnPaid = $("#btnMarkPaid");
      const btnDel = $("#btnDeleteInvoice");

      if(!inv){
        host.innerHTML = `
          <div class="item">
            <div>
              <b>Belum ada invoice dipilih</b>
              <div style="color:var(--muted); font-size:12px; margin-top:4px">
                Klik salah satu invoice untuk melihat detail dan link Exmind Pay.
              </div>
            </div>
            <span>‚Äî</span>
          </div>
        `;
        [btnPay, btnCopy, btnPaid, btnDel].forEach(b => b.disabled = true);
        return;
      }

      const total = calcInvoiceTotal(inv);
      const subtotal = (inv.items || []).reduce((a,it)=> a + (Number(it.qty||0) * Number(it.price||0)), 0);
      const tax = Math.round((subtotal - Number(inv.discount||0)) * (Number(inv.taxPct||0) / 100));

      host.innerHTML = `
        <div class="item">
          <div>
            <b>${escapeHtml(inv.number)}</b>
            <div style="color:var(--muted); font-size:12px; margin-top:4px">
              Customer: <b style="color:#dff7ff">${escapeHtml(inv.customerName||"‚Äî")}</b>
            </div>
            <div style="color:var(--muted2); font-size:12px; margin-top:6px">
              Due: <span style="font-family:var(--mono)">${escapeHtml(fmtDate(inv.dueAt))}</span>
              ‚Ä¢ Status: <span class="tag ${inv.status==='paid'?'ok':inv.status==='pending'?'warn':inv.status==='expired'?'bad':'info'}">${escapeHtml(inv.status||"unpaid")}</span>
            </div>
          </div>
          <span style="font-family:var(--mono)">${fmtIDR(total)}</span>
        </div>

        <div class="item">
          <div style="min-width:0">
            <b>Items</b>
            <div style="color:var(--muted); font-size:12px; margin-top:6px">
              ${(inv.items||[]).map(it => `‚Ä¢ ${escapeHtml(it.name)} √ó ${escapeHtml(it.qty)} @ ${fmtIDR(it.price)}`).join("<br/>") || "‚Äî"}
            </div>
          </div>
          <span>‚Äî</span>
        </div>

        <div class="item">
          <div>
            <b>Subtotal</b>
            <div style="color:var(--muted); font-size:12px; margin-top:4px">Diskon: ${fmtIDR(inv.discount||0)} ‚Ä¢ Pajak: ${escapeHtml(inv.taxPct||0)}%</div>
          </div>
          <span>${fmtIDR(subtotal - Number(inv.discount||0) + tax)}</span>
        </div>

        <div class="item">
          <div style="min-width:0">
            <b>Exmind Pay Link</b>
            <div style="color:var(--muted); font-size:12px; margin-top:6px; word-break:break-all">
              ${escapeHtml(inv.Exmind PayLink || "‚Äî")}
            </div>
          </div>
          <span>üîó</span>
        </div>

        <div class="item">
          <div style="min-width:0">
            <b>Catatan</b>
            <div style="color:var(--muted); font-size:12px; margin-top:6px">
              ${escapeHtml(inv.notes || "‚Äî")}
            </div>
          </div>
          <span>üìù</span>
        </div>
      `;

      [btnPay, btnCopy, btnPaid, btnDel].forEach(b => b.disabled = false);
    }

    // ---------- Actions ----------
    function addLead(data){
      const lead = {
        id: uid("lead"),
        name: data.name || "",
        company: data.company || "",
        phone: data.phone || "",
        source: data.source || "Other",
        status: data.status || "New",
        owner: data.owner || "Admin",
        createdAt: Date.now(),
        notes: data.notes || "",
        followUpAt: data.followUpAt || null,
      };
      state.leads.unshift(lead);
      toast("Lead berhasil ditambahkan.", "good", "Leads");
      save();
      return lead;
    }

    function updateLead(id, patch){
      const l = state.leads.find(x => x.id === id);
      if(!l) return;
      Object.assign(l, patch);
      toast("Lead berhasil diperbarui.", "good", "Leads");
      save();
    }

    function deleteLead(id){
      // if lead is linked to deals, keep but warn
      const linked = state.deals.some(d => d.leadId === id);
      if(linked){
        toast("Lead terhubung ke deal. Hapus deal dulu atau ubah leadId.", "warn", "Tidak bisa hapus");
        return;
      }
      state.leads = state.leads.filter(l => l.id !== id);
      toast("Lead dihapus.", "warn", "Leads");
      save();
    }

    function addDeal(data){
      const deal = {
        id: uid("deal"),
        leadId: data.leadId || null,
        title: data.title || "Deal",
        name: data.name || "",
        company: data.company || "",
        phone: data.phone || "",
        owner: data.owner || "Admin",
        value: Number(data.value || 0),
        stageId: data.stageId || "new",
        createdAt: Date.now(),
        followUpAt: data.followUpAt || null,
        notes: data.notes || "",
      };
      state.deals.unshift(deal);
      toast("Deal berhasil dibuat.", "good", "Pipeline");
      save();
      return deal;
    }

    function updateDeal(id, patch){
      const d = state.deals.find(x => x.id === id);
      if(!d) return;
      Object.assign(d, patch);
      toast("Deal diperbarui.", "good", "Pipeline");
      save();
    }

    function deleteDeal(id){
      const invLinked = state.invoices.some(i => i.dealId === id);
      if(invLinked){
        toast("Deal sudah terhubung invoice. Hapus invoice dulu.", "warn", "Tidak bisa hapus");
        return;
      }
      state.deals = state.deals.filter(d => d.id !== id);
      toast("Deal dihapus.", "warn", "Pipeline");
      save();
    }

    function moveDeal(id, stageId){
      const d = state.deals.find(x => x.id === id);
      if(!d) return;

      const old = d.stageId;
      d.stageId = stageId;

      if(stageId === "won"){
        toast("Deal masuk stage WON. Siap dibuat invoice Exmind Pay.", "good", "Won");
      } else if(stageId === "lost"){
        toast("Deal masuk stage LOST.", "bad", "Lost");
      } else if(old !== stageId){
        toast(`Deal dipindahkan ke ${stageById(stageId)?.name || stageId}.`, "info", "Pipeline");
      }
      save();
    }

    function addInvoice(data){
      const inv = {
        id: uid("inv"),
        number: makeInvoiceNumber(),
        customerName: data.customerName || "",
        customerPhone: data.customerPhone || "",
        items: data.items || [{ name:"Service", qty:1, price: 0 }],
        taxPct: Number(data.taxPct || 0),
        discount: Number(data.discount || 0),
        status: data.status || "unpaid",
        dueAt: data.dueAt || (Date.now() + 86400000*7),
        createdAt: Date.now(),
        dealId: data.dealId || null,
        exmindpayLink: "",
        notes: data.notes || "",
      };
      const total = calcInvoiceTotal(inv);
      inv.exmindpayLink = makeExmindPayLink(inv.customerName, total, inv.id);

      state.invoices.unshift(inv);
      state.ui.selectedInvoiceId = inv.id;
      toast("Invoice berhasil dibuat.", "good", "Invoices");
      save();
      return inv;
    }

    function updateInvoice(id, patch){
      const inv = state.invoices.find(x => x.id === id);
      if(!inv) return;
      Object.assign(inv, patch);
      const total = calcInvoiceTotal(inv);
      inv.exmindpayLink = makeExmindPayLink(inv.customerName, total, inv.id);
      toast("Invoice diperbarui.", "good", "Invoices");
      save();
    }

    function deleteInvoice(id){
      state.invoices = state.invoices.filter(i => i.id !== id);
      if(state.ui.selectedInvoiceId === id) state.ui.selectedInvoiceId = null;
      toast("Invoice dihapus.", "warn", "Invoices");
      save();
    }

    // ---------- UI Modals ----------
    function modalLeadForm(lead){
      const isEdit = !!lead;
      const l = lead || { name:"", company:"", phone:"", source:"Instagram", status:"New", owner:"Admin", notes:"", followUpAt:null };

      openModal(isEdit ? "‚úèÔ∏è Edit Lead" : "‚ûï Tambah Lead", `
        <div class="card">
          <h4>${isEdit ? "Perbarui data lead" : "Input lead baru"}</h4>
          <div class="form">
            <div class="field">
              <label>Nama</label>
              <input id="f_name" value="${escapeHtml(l.name)}" placeholder="Nama kontak" />
            </div>
            <div class="field">
              <label>Perusahaan</label>
              <input id="f_company" value="${escapeHtml(l.company)}" placeholder="Nama perusahaan" />
            </div>
            <div class="field">
              <label>WhatsApp</label>
              <input id="f_phone" value="${escapeHtml(l.phone)}" placeholder="08xxxx / +62xxxx" />
            </div>
            <div class="field">
              <label>Source</label>
              <select id="f_source">
                ${SOURCES.map(s => `<option ${s===l.source?"selected":""}>${escapeHtml(s)}</option>`).join("")}
              </select>
            </div>
            <div class="field">
              <label>Status</label>
              <select id="f_status">
                ${LEAD_STATUS.map(s => `<option ${s===l.status?"selected":""}>${escapeHtml(s)}</option>`).join("")}
              </select>
            </div>
            <div class="field">
              <label>Owner</label>
              <select id="f_owner">
                ${OWNERS.map(s => `<option ${s===l.owner?"selected":""}>${escapeHtml(s)}</option>`).join("")}
              </select>
            </div>

            <div class="field">
              <label>Follow-up Date</label>
              <input id="f_follow" type="date" value="${l.followUpAt ? dateKey(l.followUpAt) : ""}" />
            </div>
            <div class="field">
              <label>Jam Follow-up</label>
              <input id="f_follow_time" type="time" value="${l.followUpAt ? new Date(l.followUpAt).toTimeString().slice(0,5) : "09:00"}" />
            </div>

            <div class="field full">
              <label>Catatan</label>
              <textarea id="f_notes" placeholder="Catatan kebutuhan lead...">${escapeHtml(l.notes)}</textarea>
            </div>
          </div>

          <div class="hr"></div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
            ${isEdit ? `<button class="btn danger" id="btnDelLead">üóë Hapus</button>` : ""}
            <button class="btn" onclick="window.__closeModal()">Batal</button>
            <button class="btn primary" id="btnSaveLead">Simpan</button>
          </div>
        </div>
      `);

      $("#btnSaveLead").onclick = () => {
        const name = $("#f_name").value.trim();
        const company = $("#f_company").value.trim();
        const phone = $("#f_phone").value.trim();
        const source = $("#f_source").value;
        const status = $("#f_status").value;
        const owner = $("#f_owner").value;
        const notes = $("#f_notes").value.trim();

        const d = $("#f_follow").value;
        const t = $("#f_follow_time").value || "09:00";
        let followUpAt = null;
        if(d){
          const [hh,mm] = t.split(":").map(Number);
          const dt = new Date(d);
          dt.setHours(hh||9, mm||0, 0, 0);
          followUpAt = dt.getTime();
        }

        if(!name && !company){
          toast("Minimal isi Nama atau Perusahaan.", "warn", "Validasi");
          return;
        }

        if(isEdit){
          updateLead(lead.id, { name, company, phone, source, status, owner, notes, followUpAt });
        }else{
          addLead({ name, company, phone, source, status, owner, notes, followUpAt });
        }
        closeModal();
      };

      if(isEdit){
        $("#btnDelLead").onclick = () => {
          if(confirm("Hapus lead ini? (Jika terhubung deal, tidak bisa)")){
            deleteLead(lead.id);
            closeModal();
          }
        };
      }
    }

    function modalDealForm(deal, preset={}){
      const isEdit = !!deal;
      const d = deal || {
        leadId: preset.leadId || null,
        title: preset.title || "Deal",
        name: preset.name || "",
        company: preset.company || "",
        phone: preset.phone || "",
        owner: preset.owner || "Admin",
        value: preset.value || 0,
        stageId: preset.stageId || "new",
        followUpAt: preset.followUpAt || null,
        notes: preset.notes || ""
      };

      openModal(isEdit ? "‚úèÔ∏è Edit Deal" : "‚ûï Tambah Deal", `
        <div class="card">
          <h4>${isEdit ? "Perbarui data deal" : "Input deal baru"}</h4>

          <div class="form">
            <div class="field full">
              <label>Judul Deal</label>
              <input id="d_title" value="${escapeHtml(d.title)}" placeholder="Contoh: Website + SEO" />
            </div>

            <div class="field">
              <label>Nama</label>
              <input id="d_name" value="${escapeHtml(d.name)}" placeholder="Nama kontak" />
            </div>
            <div class="field">
              <label>Perusahaan</label>
              <input id="d_company" value="${escapeHtml(d.company)}" placeholder="Nama perusahaan" />
            </div>

            <div class="field">
              <label>WhatsApp</label>
              <input id="d_phone" value="${escapeHtml(d.phone)}" placeholder="08xxxx / +62xxxx" />
            </div>
            <div class="field">
              <label>Owner</label>
              <select id="d_owner">
                ${OWNERS.map(s => `<option ${s===d.owner?"selected":""}>${escapeHtml(s)}</option>`).join("")}
              </select>
            </div>

            <div class="field">
              <label>Value (IDR)</label>
              <input id="d_value" type="number" value="${escapeHtml(d.value)}" placeholder="Contoh: 25000000" />
            </div>
            <div class="field">
              <label>Stage</label>
              <select id="d_stage">
                ${state.stages.map(s => `<option value="${escapeHtml(s.id)}" ${s.id===d.stageId?"selected":""}>${escapeHtml(s.name)}</option>`).join("")}
              </select>
            </div>

            <div class="field">
              <label>Follow-up Date</label>
              <input id="d_follow" type="date" value="${d.followUpAt ? dateKey(d.followUpAt) : ""}" />
            </div>
            <div class="field">
              <label>Jam Follow-up</label>
              <input id="d_follow_time" type="time" value="${d.followUpAt ? new Date(d.followUpAt).toTimeString().slice(0,5) : "10:00"}" />
            </div>

            <div class="field full">
              <label>Catatan</label>
              <textarea id="d_notes" placeholder="Catatan progress...">${escapeHtml(d.notes)}</textarea>
            </div>
          </div>

          <div class="hr"></div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
            ${isEdit ? `<button class="btn danger" id="btnDelDeal">üóë Hapus</button>` : ""}
            <button class="btn" onclick="window.__closeModal()">Batal</button>
            <button class="btn primary" id="btnSaveDeal">Simpan</button>
          </div>
        </div>
      `);

      $("#btnSaveDeal").onclick = () => {
        const title = $("#d_title").value.trim() || "Deal";
        const name = $("#d_name").value.trim();
        const company = $("#d_company").value.trim();
        const phone = $("#d_phone").value.trim();
        const owner = $("#d_owner").value;
        const value = Number($("#d_value").value || 0);
        const stageId = $("#d_stage").value;
        const notes = $("#d_notes").value.trim();

        const ddate = $("#d_follow").value;
        const t = $("#d_follow_time").value || "10:00";
        let followUpAt = null;
        if(ddate){
          const [hh,mm] = t.split(":").map(Number);
          const dt = new Date(ddate);
          dt.setHours(hh||10, mm||0, 0, 0);
          followUpAt = dt.getTime();
        }

        if(!company && !name){
          toast("Minimal isi Nama atau Perusahaan.", "warn", "Validasi");
          return;
        }

        if(isEdit){
          updateDeal(deal.id, { title, name, company, phone, owner, value, stageId, followUpAt, notes });
        }else{
          addDeal({ leadId: d.leadId, title, name, company, phone, owner, value, stageId, followUpAt, notes });
        }
        closeModal();
      };

      if(isEdit){
        $("#btnDelDeal").onclick = () => {
          if(confirm("Hapus deal ini? (Jika terhubung invoice, tidak bisa)")){
            deleteDeal(deal.id);
            closeModal();
          }
        };
      }
    }

    function modalDealDetail(deal){
      const st = stageById(deal.stageId)?.name || deal.stageId;
      const due = deal.followUpAt ? fmtDate(deal.followUpAt) : "‚Äî";

      const waTemplates = [
        { name:"Follow-up 1", text:`Halo ${deal.name || ""}, saya dari ${state.meta.company}. Saya follow-up terkait ${deal.title}. Apakah bisa kita lanjutkan pembahasannya hari ini?` },
        { name:"Proposal", text:`Halo ${deal.name || ""}, saya sudah siapkan proposal untuk ${deal.title}. Saya kirim ya, kalau ada revisi kita adjust.` },
        { name:"Closing", text:`Halo ${deal.name || ""}, jika sudah cocok, saya bisa buatkan invoice dan link pembayaran via Exmind Pay agar prosesnya cepat.` },
      ];

      openModal("üß© Detail Deal", `
        <div class="inv-grid">
          <div class="card">
            <h4>${escapeHtml(deal.title)}</h4>

            <div class="kv">
              <div class="item">
                <div>
                  <b>${escapeHtml(deal.company || "‚Äî")}</b>
                  <div style="color:var(--muted); font-size:12px; margin-top:4px">
                    Kontak: <b style="color:#dff7ff">${escapeHtml(deal.name || "‚Äî")}</b>
                    ‚Ä¢ WA: <span style="font-family:var(--mono)">${escapeHtml(deal.phone || "‚Äî")}</span>
                  </div>
                  <div style="color:var(--muted2); font-size:12px; margin-top:6px">
                    Stage: <span class="tag info">${escapeHtml(st)}</span>
                    ‚Ä¢ Owner: <span class="tag">${escapeHtml(deal.owner || "‚Äî")}</span>
                    ‚Ä¢ Follow-up: <span class="tag">${escapeHtml(due)}</span>
                  </div>
                </div>
                <span style="font-family:var(--mono)">${fmtIDR(deal.value || 0)}</span>
              </div>

              <div class="item">
                <div style="min-width:0">
                  <b>Catatan</b>
                  <div style="color:var(--muted); font-size:12px; margin-top:6px">
                    ${escapeHtml(deal.notes || "‚Äî")}
                  </div>
                </div>
                <span>üìù</span>
              </div>
            </div>

            <div class="hr"></div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn" id="btnEditDeal">‚úèÔ∏è Edit</button>
              <button class="btn" id="btnWADeal">üì© WA</button>
              <button class="btn warn" id="btnSetToday">üìÖ Follow-up Today</button>
              <button class="btn good" id="btnMarkWon">üèÅ Mark Won</button>
              <button class="btn danger" id="btnMarkLost">‚õî Mark Lost</button>
              <button class="btn good" id="btnInvFromDeal">üßæ Buat Invoice</button>
            </div>
          </div>

          <div class="card">
            <h4>üì® WA Templates</h4>
            <div class="kv">
              ${waTemplates.map(t => `
                <div class="item">
                  <div style="min-width:0">
                    <b>${escapeHtml(t.name)}</b>
                    <div style="color:var(--muted); font-size:12px; margin-top:6px">
                      ${escapeHtml(t.text)}
                    </div>
                  </div>
                  <span>
                    <button class="btn small" onclick="window.__sendWATemplate('${escapeHtml(deal.id)}','${escapeHtml(t.name)}')">Kirim</button>
                  </span>
                </div>
              `).join("")}
            </div>
          </div>
        </div>
      `);

      $("#btnEditDeal").onclick = () => {
        closeModal();
        modalDealForm(deal);
      };

      $("#btnWADeal").onclick = () => openWA(deal.phone, deal.title, deal.company);

      $("#btnSetToday").onclick = () => {
        const dt = new Date();
        dt.setHours(10,0,0,0);
        updateDeal(deal.id, { followUpAt: dt.getTime() });
        toast("Follow-up diset untuk hari ini.", "good", "Follow-up");
      };

      $("#btnMarkWon").onclick = () => {
        moveDeal(deal.id, "won");
        closeModal();
      };

      $("#btnMarkLost").onclick = () => {
        moveDeal(deal.id, "lost");
        closeModal();
      };

      $("#btnInvFromDeal").onclick = () => {
        closeModal();
        dealToInvoice(deal.id);
      };
    }

    function modalInvoiceForm(inv, preset={}){
      const isEdit = !!inv;

      const x = inv || {
        customerName: preset.customerName || "",
        customerPhone: preset.customerPhone || "",
        items: preset.items || [{ name: preset.itemName || "Service", qty:1, price: preset.price || 0 }],
        taxPct: preset.taxPct || 0,
        discount: preset.discount || 0,
        status: preset.status || "unpaid",
        dueAt: preset.dueAt || (Date.now() + 86400000*7),
        dealId: preset.dealId || null,
        notes: preset.notes || "",
      };

      openModal(isEdit ? "‚úèÔ∏è Edit Invoice" : "‚ûï Buat Invoice", `
        <div class="card">
          <h4>${isEdit ? escapeHtml(inv.number) : "Invoice baru"}</h4>

          <div class="form">
            <div class="field">
              <label>Customer</label>
              <input id="i_customer" value="${escapeHtml(x.customerName)}" placeholder="Nama perusahaan / customer" />
            </div>
            <div class="field">
              <label>WhatsApp</label>
              <input id="i_phone" value="${escapeHtml(x.customerPhone)}" placeholder="08xxxx / +62xxxx" />
            </div>

            <div class="field full">
              <label>Item</label>
              <input id="i_item" value="${escapeHtml((x.items?.[0]?.name)||"Service")}" placeholder="Contoh: Website + SEO" />
            </div>

            <div class="field">
              <label>Qty</label>
              <input id="i_qty" type="number" value="${escapeHtml((x.items?.[0]?.qty)||1)}" />
            </div>
            <div class="field">
              <label>Price (IDR)</label>
              <input id="i_price" type="number" value="${escapeHtml((x.items?.[0]?.price)||0)}" />
            </div>

            <div class="field">
              <label>Diskon (IDR)</label>
              <input id="i_disc" type="number" value="${escapeHtml(x.discount||0)}" />
            </div>
            <div class="field">
              <label>Pajak (%)</label>
              <input id="i_tax" type="number" value="${escapeHtml(x.taxPct||0)}" />
            </div>

            <div class="field">
              <label>Status</label>
              <select id="i_status">
                ${["unpaid","pending","paid","expired"].map(s => `<option value="${s}" ${s===(x.status||"unpaid")?"selected":""}>${s}</option>`).join("")}
              </select>
            </div>
            <div class="field">
              <label>Due Date</label>
              <input id="i_due" type="date" value="${dateKey(x.dueAt)}" />
            </div>

            <div class="field full">
              <label>Catatan</label>
              <textarea id="i_notes" placeholder="Catatan invoice...">${escapeHtml(x.notes||"")}</textarea>
            </div>
          </div>

          <div class="hr"></div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
            ${isEdit ? `<button class="btn danger" id="btnDelInv">üóë Hapus</button>` : ""}
            <button class="btn" onclick="window.__closeModal()">Batal</button>
            <button class="btn primary" id="btnSaveInv">Simpan</button>
          </div>
        </div>
      `);

      $("#btnSaveInv").onclick = () => {
        const customerName = $("#i_customer").value.trim();
        const customerPhone = $("#i_phone").value.trim();
        const itemName = $("#i_item").value.trim() || "Service";
        const qty = Number($("#i_qty").value || 1);
        const price = Number($("#i_price").value || 0);
        const discount = Number($("#i_disc").value || 0);
        const taxPct = Number($("#i_tax").value || 0);
        const status = $("#i_status").value;
        const due = $("#i_due").value;
        const notes = $("#i_notes").value.trim();

        if(!customerName){
          toast("Customer wajib diisi.", "warn", "Validasi");
          return;
        }

        const dueAt = due ? new Date(due).getTime() : (Date.now() + 86400000*7);
        const items = [{ name:itemName, qty: Math.max(1, qty||1), price: Math.max(0, price||0) }];

        if(isEdit){
          updateInvoice(inv.id, { customerName, customerPhone, items, discount, taxPct, status, dueAt, notes });
        }else{
          addInvoice({ customerName, customerPhone, items, discount, taxPct, status, dueAt, notes, dealId: x.dealId || null });
        }
        closeModal();
      };

      if(isEdit){
        $("#btnDelInv").onclick = () => {
          if(confirm("Hapus invoice ini?")){
            deleteInvoice(inv.id);
            closeModal();
          }
        };
      }
    }

    function modalStageConfig(){
      openModal("‚öôÔ∏è Stage Config", `
        <div class="card">
          <h4>Atur nama stage (MVP)</h4>
          <div style="color:var(--muted); font-size:12px; line-height:1.5">
            Kamu bisa rename stage. Untuk tambah/hapus stage versi MVP belum dibuat (biar stabil).
          </div>

          <div class="hr"></div>

          <div class="form">
            ${state.stages.map(s => `
              <div class="field full">
                <label>${escapeHtml(s.id)}</label>
                <input data-stage="${escapeHtml(s.id)}" value="${escapeHtml(s.name)}" />
              </div>
            `).join("")}
          </div>

          <div class="hr"></div>

          <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap">
            <button class="btn" onclick="window.__closeModal()">Batal</button>
            <button class="btn primary" id="btnSaveStages">Simpan</button>
          </div>
        </div>
      `);

      $("#btnSaveStages").onclick = () => {
        $$("#modalBody input[data-stage]").forEach(inp => {
          const id = inp.dataset.stage;
          const s = state.stages.find(x => x.id === id);
          if(s) s.name = inp.value.trim() || s.name;
        });
        toast("Stage berhasil diperbarui.", "good", "Pipeline");
        closeModal();
        save();
      };
    }

    function modalTemplates(){
      openModal("üì® WA Templates", `
        <div class="card">
          <h4>Template Follow-up (internal)</h4>
          <div style="color:var(--muted); font-size:12px; line-height:1.5">
            Ini template cepat. Kamu bisa copy dan kirim via tombol WA.
          </div>

          <div class="hr"></div>

          <div class="kv">
            ${[
              { name:"Follow-up (umum)", text:`Halo kak, saya follow-up terkait kebutuhan yang kemarin. Apakah bisa kita lanjutkan hari ini?` },
              { name:"Kirim proposal", text:`Halo kak, saya sudah siapkan proposal. Saya kirim ya, kalau ada revisi kita adjust.` },
              { name:"Invoice & Exmind Pay", text:`Halo kak, kalau sudah oke, saya bisa buatkan invoice dan link pembayaran via Exmind Pay agar prosesnya cepat.` },
              { name:"Meeting schedule", text:`Halo kak, untuk lanjut pembahasan, boleh kita jadwalkan meeting? Saya fleksibel jam 10.00‚Äì17.00.` },
            ].map(t => `
              <div class="item">
                <div style="min-width:0">
                  <b>${escapeHtml(t.name)}</b>
                  <div style="color:var(--muted); font-size:12px; margin-top:6px">${escapeHtml(t.text)}</div>
                </div>
                <span><button class="btn small" onclick="navigator.clipboard.writeText('${escapeHtml(t.text)}'); window.__toast('Template dicopy.','good','WA Template')">Copy</button></span>
              </div>
            `).join("")}
          </div>

          <div class="hr"></div>

          <div style="display:flex; gap:10px; justify-content:flex-end">
            <button class="btn primary" onclick="window.__closeModal()">Tutup</button>
          </div>
        </div>
      `);
    }

    // ---------- WA ----------
    function openWA(phone, contextTitle="", company=""){
      const p = normalizePhone(phone);
      if(!p){
        toast("Nomor WA kosong / tidak valid.", "warn", "WhatsApp");
        return;
      }

      const msg = [
        "Halo,",
        `Saya dari ${state.meta.company}.`,
        contextTitle ? `Saya follow-up terkait: ${contextTitle}.` : "",
        company ? `Untuk: ${company}.` : "",
        "",
        "Terima kasih üôè"
      ].filter(Boolean).join(" ");

      const link = waLink(p, msg);
      window.open(link, "_blank", "noopener,noreferrer");
    }

    function sendWATemplate(dealId, templateName){
      const d = state.deals.find(x => x.id === dealId);
      if(!d) return;

      let text = "";
      if(templateName === "Follow-up 1"){
        text = `Halo ${d.name || ""}, saya dari ${state.meta.company}. Saya follow-up terkait ${d.title}. Apakah bisa kita lanjutkan pembahasannya hari ini?`;
      } else if(templateName === "Proposal"){
        text = `Halo ${d.name || ""}, saya sudah siapkan proposal untuk ${d.title}. Saya kirim ya, kalau ada revisi kita adjust.`;
      } else if(templateName === "Closing"){
        text = `Halo ${d.name || ""}, jika sudah cocok, saya bisa buatkan invoice dan link pembayaran via Exmind Pay agar prosesnya cepat.`;
      } else {
        text = `Halo ${d.name || ""}, saya follow-up terkait ${d.title}.`;
      }

      const link = waLink(d.phone, text);
      if(!link){
        toast("Nomor WA tidak valid.", "warn", "WhatsApp");
        return;
      }
      window.open(link, "_blank", "noopener,noreferrer");
      toast(`Template "${templateName}" dibuka di WhatsApp.`, "good", "WhatsApp");
    }

    // ---------- Conversions ----------
    function leadToDeal(leadId){
      const l = state.leads.find(x => x.id === leadId);
      if(!l) return;
      modalDealForm(null, {
        leadId: l.id,
        title: "Deal Baru",
        name: l.name,
        company: l.company,
        phone: l.phone,
        owner: l.owner,
        stageId: "new",
        value: 0,
        followUpAt: l.followUpAt || null,
        notes: l.notes || ""
      });
    }

    function dealToInvoice(dealId){
      const d = state.deals.find(x => x.id === dealId);
      if(!d) return;

      const exists = state.invoices.find(i => i.dealId === d.id);
      if(exists){
        state.ui.selectedInvoiceId = exists.id;
        setView("invoices");
        toast("Invoice dari deal ini sudah ada. Dibuka di Invoices.", "info", "Invoices");
        return;
      }

      modalInvoiceForm(null, {
        dealId: d.id,
        customerName: d.company || d.name || "Customer",
        customerPhone: d.phone || "",
        itemName: d.title || "Service",
        price: Number(d.value||0),
        notes: `Invoice otomatis dari deal: ${d.title}`,
        dueAt: Date.now() + 86400000*7
      });
    }

    function wonToInvoice(){
      const won = state.deals
        .filter(d => d.stageId === "won")
        .filter(d => !state.invoices.some(i => i.dealId === d.id));

      if(won.length === 0){
        toast("Tidak ada deal Won yang belum dibuat invoice.", "info", "Won ‚Üí Invoice");
        return;
      }

      // Create invoice for first one (MVP)
      dealToInvoice(won[0].id);
    }

    // ---------- CSV Import ----------
    function importCSV(text){
      // Expected headers (flexible):
      // name, company, phone, source, status, owner, notes
      const lines = text.split(/\r?\n/).filter(Boolean);
      if(lines.length < 2){
        toast("CSV kosong / format tidak valid.", "warn", "Import CSV");
        return;
      }

      const headers = lines[0].split(",").map(h => h.trim().toLowerCase());
      const idx = (key) => headers.indexOf(key);

      let added = 0;

      for(let i=1;i<lines.length;i++){
        const row = lines[i].split(",").map(x => x.trim());
        if(row.length < 2) continue;

        const data = {
          name: row[idx("name")] ?? row[0] ?? "",
          company: row[idx("company")] ?? row[1] ?? "",
          phone: row[idx("phone")] ?? "",
          source: row[idx("source")] ?? "Other",
          status: row[idx("status")] ?? "New",
          owner: row[idx("owner")] ?? "Admin",
          notes: row[idx("notes")] ?? ""
        };

        if(!data.name && !data.company) continue;
        addLead(data);
        added++;
      }

      toast(`${added} lead berhasil diimport.`, "good", "Import CSV");
      save();
    }

    // ---------- Export ----------
    function exportJSON(){
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `Exmind-crm-mvp-export-${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("Export JSON berhasil.", "good", "Export");
    }

    // ---------- Events ----------
    // nav
    $$(".navbtn").forEach(btn => btn.addEventListener("click", ()=> setView(btn.dataset.view)));

    // chips
    $$(".chip").forEach(ch => ch.addEventListener("click", ()=>{
      state.ui.filter = ch.dataset.filter;
      save();
    }));

    // search
    $("#q").addEventListener("input", ()=>{
      // no save for query
      render();
    });

    // top actions
    $("#btnNewLead").onclick = () => modalLeadForm(null);
    $("#btnNewDeal").onclick = () => modalDealForm(null);
    $("#btnExport").onclick = exportJSON;

    // sidebar actions
    $("#btnSeed").onclick = seed;
    $("#btnReset").onclick = () => {
      if(confirm("Reset semua data Exmind CRM MVP?")){
        resetAll();
      }
    };

    // leads view actions
    $("#btnImportCSV").onclick = () => $("#csvFile").click();
    $("#csvFile").addEventListener("change", async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      const text = await file.text();
      importCSV(text);
      e.target.value = "";
    });

    $("#btnAddFromDeal").onclick = () => {
      // quick: pick a deal to create lead (MVP)
      const d = state.deals[0];
      if(!d){
        toast("Belum ada deal.", "info", "Leads");
        return;
      }
      addLead({
        name: d.name,
        company: d.company,
        phone: d.phone,
        source: "Other",
        status: "New",
        owner: d.owner,
        notes: `Auto dari deal: ${d.title}`
      });
    };

    // pipeline actions
    $("#btnStageConfig").onclick = modalStageConfig;
    $("#btnWonToInvoice").onclick = wonToInvoice;

    // invoices actions
    $("#btnNewInvoice").onclick = () => modalInvoiceForm(null);
    $("#btnMarkAllPending").onclick = () => {
      state.invoices.forEach(i => {
        if(i.status === "unpaid") i.status = "pending";
      });
      toast("Invoice unpaid ditandai pending.", "info", "Invoices");
      save();
    };

    // dashboard quick actions
    $("#btnQuickFollow").onclick = () => setView("pipeline");
    $("#btnQuickInvoice").onclick = wonToInvoice;

    // invoice preview actions
    $("#btnPayExmind Pay").onclick = () => {
      const inv = state.invoices.find(i => i.id === state.ui.selectedInvoiceId);
      if(!inv) return;
      window.open(inv.exmindpayLink, "_blank", "noopener,noreferrer");
      toast("Link ExmindPay dibuka.", "good", "ExmindPay");
    };
    $("#btnCopyPayLink").onclick = () => copyPayLink(state.ui.selectedInvoiceId);
    $("#btnMarkPaid").onclick = () => markPaid(state.ui.selectedInvoiceId);
    $("#btnDeleteInvoice").onclick = () => {
      const id = state.ui.selectedInvoiceId;
      if(!id) return;
      if(confirm("Hapus invoice ini?")){
        deleteInvoice(id);
      }
    };

    // ---------- Global functions for inline onclick ----------
    window.__closeModal = closeModal;
    window.__toast = toast;

    window.__jump = (view) => setView(view);
    window.__openTemplates = modalTemplates;

    window.__editLead = (id) => {
      const l = state.leads.find(x => x.id === id);
      if(l) modalLeadForm(l);
    };
    window.__deleteLead = (id) => deleteLead(id);
    window.__leadToDeal = (id) => leadToDeal(id);

    window.__openDeal = (id) => {
      const d = state.deals.find(x => x.id === id);
      if(d) modalDealDetail(d);
    };

    window.__openWA = (phone, type, id) => {
      // type: lead/deal
      if(type === "lead"){
        const l = state.leads.find(x => x.id === id);
        if(!l) return;
        openWA(l.phone, "Follow-up", l.company);
      }else{
        const d = state.deals.find(x => x.id === id);
        if(!d) return;
        openWA(d.phone, d.title, d.company);
      }
    };

    window.__sendWATemplate = (dealId, name) => sendWATemplate(dealId, name);

    window.__dealToInvoice = (dealId) => dealToInvoice(dealId);
    window.__wonToInvoice = wonToInvoice;

    window.__selectInvoice = (id) => {
      state.ui.selectedInvoiceId = id;
      save();
    };

    window.__openInvoice = (id) => {
      const inv = state.invoices.find(x => x.id === id);
      if(inv) modalInvoiceForm(inv);
    };

    window.__copyPayLink = (id) => copyPayLink(id);
    window.__markPaid = (id) => markPaid(id);

    // ---------- Invoice quick ----------
    function copyPayLink(id){
      const inv = state.invoices.find(i => i.id === id);
      if(!inv) return;
      navigator.clipboard.writeText(inv.exmindpayLink || "");
      toast("Link Exmind Pay dicopy.", "good", "Copy");
    }

    function markPaid(id){
      const inv = state.invoices.find(i => i.id === id);
      if(!inv) return;
      inv.status = "paid";
      toast("Invoice ditandai PAID.", "good", "Paid");
      save();
    }

    // ---------- Init ----------
    // set env pill
    $("#envPill").textContent = "localStorage";

    // default filter behavior (MVP)
    // - all: show all
    // - today: prioritize followUp today (but we only filter in hot & suggestions)
    // - hot: only show hot items
    // We'll implement "hot" as a hard filter for tables & pipeline.
    function applyFilter(){
      const f = state.ui.filter;

      if(f === "hot"){
        // Filter leads & deals arrays in render by query only (MVP: not modifying data)
        // We'll simply hide non-hot by using query injection.
        // (Better: add conditional in render methods.)
      }
    }

    // Patch render methods to respect filter
    const _renderLeads = renderLeads;
    renderLeads = function(){
      const host = $("#leadRows");
      const q = currentQuery();
      const f = state.ui.filter;

      let list = state.leads
        .filter(l => filterMatch(l,q))
        .sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));

      if(f === "hot") list = list.filter(isHot);
      if(f === "today") list = list.filter(l => l.followUpAt && dateKey(l.followUpAt) === todayKey());

      if(list.length === 0){
        host.innerHTML = `
          <tr>
            <td colspan="7" style="color:var(--muted); padding:18px">
              Tidak ada leads untuk filter <b>${escapeHtml(f)}</b>.
            </td>
          </tr>
        `;
        return;
      }

      host.innerHTML = list.map(l => {
        const st = l.status || "New";
        const tagCls = st === "Qualified" ? "ok" : st === "Contacted" ? "warn" : st === "Lost" ? "bad" : "info";

        return `
          <tr>
            <td>
              <div style="display:flex; flex-direction:column; gap:4px">
                <b>${escapeHtml(l.name||"‚Äî")}</b>
                <span style="color:var(--muted); font-size:12px">${fmtDate(l.createdAt)}</span>
              </div>
            </td>
            <td>${escapeHtml(l.company||"‚Äî")}</td>
            <td style="font-family:var(--mono)">${escapeHtml(l.phone||"‚Äî")}</td>
            <td><span class="tag">${escapeHtml(l.source||"‚Äî")}</span></td>
            <td><span class="tag ${tagCls}">${escapeHtml(st)}</span></td>
            <td><span class="tag">${escapeHtml(l.owner||"‚Äî")}</span></td>
            <td style="text-align:right">
              <div class="t-actions">
                <button class="btn small" onclick="window.__leadToDeal('${l.id}')">‚ûï Deal</button>
                <button class="btn small" onclick="window.__editLead('${l.id}')">‚úèÔ∏è Edit</button>
                <button class="btn small" onclick="window.__openWA('${escapeHtml(l.phone||"")}','lead','${l.id}')">WA</button>
                <button class="btn small danger" onclick="window.__deleteLead('${l.id}')">üóë</button>
              </div>
            </td>
          </tr>
        `;
      }).join("");
    };

    const _renderPipeline = renderPipeline;
    renderPipeline = function(){
      const host = $("#pipeline");
      const q = currentQuery();
      const f = state.ui.filter;

      host.innerHTML = state.stages.map(s => {
        let deals = state.deals
          .filter(d => d.stageId === s.id)
          .filter(d => filterMatch(d,q))
          .sort((a,b)=> (b.value||0)-(a.value||0));

        if(f === "hot") deals = deals.filter(isHot);
        if(f === "today") deals = deals.filter(d => d.followUpAt && dateKey(d.followUpAt) === todayKey());

        const sum = deals.reduce((a,d)=> a + Number(d.value||0), 0);

        return `
          <div class="col" data-stage="${escapeHtml(s.id)}">
            <div class="ch">
              <div style="min-width:0">
                <b>${escapeHtml(s.name)}</b>
                <span>${deals.length} deal ‚Ä¢ ${fmtIDR(sum)}</span>
              </div>
              <span class="tag">${escapeHtml(s.id)}</span>
            </div>
            <div class="drop" data-drop="${escapeHtml(s.id)}">
              ${deals.map(d => dealCard(d)).join("")}
              ${deals.length ? "" : `<div style="color:var(--muted); font-size:12px; padding:8px 6px">Drop deal di sini‚Ä¶</div>`}
            </div>
          </div>
        `;
      }).join("");

      // drag handlers
      $$(".deal").forEach(el => {
        el.addEventListener("dragstart", (e)=>{
          e.dataTransfer.setData("text/plain", el.dataset.id);
          e.dataTransfer.effectAllowed = "move";
          setTimeout(()=> el.style.opacity = ".55", 0);
        });
        el.addEventListener("dragend", ()=>{
          el.style.opacity = "1";
        });
      });

      $$(".drop").forEach(drop => {
        drop.addEventListener("dragover", (e)=>{
          e.preventDefault();
          drop.style.outline = "2px dashed rgba(102,217,255,.35)";
          drop.style.outlineOffset = "6px";
        });
        drop.addEventListener("dragleave", ()=>{
          drop.style.outline = "";
          drop.style.outlineOffset = "";
        });
        drop.addEventListener("drop", (e)=>{
          e.preventDefault();
          drop.style.outline = "";
          drop.style.outlineOffset = "";
          const id = e.dataTransfer.getData("text/plain");
          const stageId = drop.dataset.drop;
          moveDeal(id, stageId);
        });
      });
    };

    // filter persistence on chip click
    $$(".chip").forEach(ch => ch.addEventListener("click", ()=>{
      state.ui.filter = ch.dataset.filter;
      render();
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }));

    // global select invoice
    window.__selectInvoice = (id) => {
      state.ui.selectedInvoiceId = id;
      render();
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    };

    // initial render
    render();

    // if no data, show toast hint
    if(state.leads.length === 0 && state.deals.length === 0){
      toast("Klik ‚ú® Seed Demo untuk isi data contoh, atau mulai input lead/deal.", "info", "Exmind CRM MVP");
    }
  </script>
</body>
</html>
